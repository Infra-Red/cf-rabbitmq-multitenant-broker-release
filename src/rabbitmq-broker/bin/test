#!/bin/bash -x

cd $(dirname $0)/..

set -e

ERLANG_COOKIE=12345
RABBITMQ_ERLANG_COOKIE_PATH=/var/lib/rabbitmq/.erlang.cookie
echo $ERLANG_COOKIE > $HOME/.erlang.cookie
chmod 400 $HOME/.erlang.cookie
echo $ERLANG_COOKIE > $RABBITMQ_ERLANG_COOKIE_PATH
chmod 400 $RABBITMQ_ERLANG_COOKIE_PATH
chown rabbitmq:rabbitmq $RABBITMQ_ERLANG_COOKIE_PATH

echo "About to start rabbitmq"

service rabbitmq-server start
rabbitmq-plugins enable rabbitmq_management

echo "About to run the go broker"
pushd ../rabbitmq-service-broker
  config=../rabbitmq-broker/test/config/valid.yml
  make run config_path="$config" &
popd

 echo "About to run lein test"
 lein test
